@use 'const';
@use 'mixin';

// ### TODO
// Edge/IE currently has issue displaying with native ruby-position,
// which will be fixed through the next Han.css version.
//

h-ru {
  display: ruby;

  &[order='0'] {
    -webkit-ruby-position: over;
    ruby-position: over;
  }

  &[order='1'],
  &.rightangle {
    -webkit-ruby-position: under;
    ruby-position: under;
  }

  rt {
    display: ruby-text;
  }
}

ruby.zhuyin,
ruby.mps,
h-ruby.zhuyin {
  h-zhuyin {
    position: relative;
    letter-spacing: 0;
  }

  h-diao {
    position: absolute;
    right: -0.9em;
    bottom: 0.5em;
    display: block;
    font-size: 1.5em;

    h-char {
      -webkit-writing-mode: horizontal-tb;
      writing-mode: horizontal-tb;
    }
  }

  [diao='˙'] h-diao {
    top: -0.3em;
    right: auto;
    bottom: auto;
    left: 0;
    font-size: 1em;
  }

  [diao^='ㆴ'],
  [diao^='ㆵ'],
  [diao^='ㆶ'],
  [diao^='ㆷ'],
  [diao='󳆴'],
  [diao='󳆵'],
  [diao='󳆶'],
  [diao='󳆷'] {
    h-diao {
      right: -1em;
      bottom: -0.125em;
      font-size: 1em;
    }
  }
}

// .no-ruby-display (L62–107)
h-ru[annotation] {
  position: relative;
  display: inline-table;
  border-collapse: collapse;
  border-spacing: 0;
  line-height: 1.1;
  text-align: center;
  vertical-align: 1em;

  > h-ru[annotation] {
    vertical-align: -0.1em;
  }

  > h-ru,
  > rb,
  > rt {
    line-height: 1;
    text-align: center;
  }

  > rt {
    display: table-header-group;
    height: 1em;
    font-size: 0.5em;
    white-space: nowrap;
    word-break: normal;

    &:before,
    &:after {
      content: '\2006';
    }
  }
}

h-ru[order='0'] > rt,
h-ruby[rightangle][doubleline] h-ru[order='0'] > rt {
  display: table-header-group;
}

h-ru[order='1'] > rt,
h-ruby[rightangle] h-ru[order='0'] > rt,
h-ruby[rightangle][doubleline] h-ru[order='1'] > rt {
  display: table-footer-group;
}

h-ru[order='0'] > h-ru[order='1'] {
  vertical-align: 0.15em;
}

h-ruby[rightangle][doubleline] h-ru[order='0'] rt {
  line-height: 1.5;
}

h-ruby[rightangle][doubleline] h-ru[annotation] {
  vertical-align: 0.5em;
}

// Zhuyin
// --------
%han-zhuyin {
  h-zhuyin {
    @include mixin.han-typo-reset;
    position: relative;
    display: inline-block;
    height: 1em;
    width: 0.4em;
    vertical-align: text-top;
  }

  h-zhuyin > * {
    @include mixin.han-scale(const.$HAN-ZHUYIN-SIZE);
    display: inline-block;
  }

  h-yin {
    position: absolute;
    left: 0;
    height: 1em;
    vertical-align: top;
    line-height: 1;
  }

  h-diao {
    position: absolute;
    bottom: 0;
    right: -0.9em;
    line-height: 1;
  }

  h-yin:empty,
  h-diao:empty {
    display: none;
  }

  [length='0'] {
    margin-right: 0;

    h-zhuyin {
      display: none;
    }
  }

  [length='1'] {
    h-yin {
      top: 0.3em;
    }

    h-diao {
      bottom: 0;
    }
  }

  [length='2'] {
    h-yin {
      top: 0.05em;
    }

    h-diao {
      bottom: -0.3em;
    }
  }

  [length='3'] {
    h-yin {
      top: -0.05em;
      line-height: 0.85;
    }

    h-diao {
      bottom: -0.35em;
    }
  }

  [diao='˙'] {
    h-diao {
      top: 0;
      right: auto;
      bottom: auto;
      left: 0.06em;
    }

    [length='1'] h-diao {
      top: 0.15em;
    }

    [length='2'] h-diao {
      top: -0.05em;
    }

    [length='3'] h-diao {
      top: -0.2em;
    }
  }

  [diao='˪'],
  [diao='˫'] {
    h-diao {
      @include mixin.han-scale(0.6);
    }
  }

  [diao^='ㆴ'],
  [diao^='ㆵ'],
  [diao^='ㆶ'],
  [diao^='ㆷ'],
  [diao='󳆴'],
  [diao='󳆵'],
  [diao='󳆶'],
  [diao='󳆷'] {
    h-diao {
      bottom: -0.6em;
      margin-right: 0.3em;
    }
  }
}

[zhuyin] {
  @extend %han-zhuyin;
  margin-right: 0.2em;
  display: inline-block;
  line-height: 1.8;
}

// Right-angle
// -------------
[rightangle] {
  h-ru[annotation] {
    vertical-align: 0;
    line-height: 1;
  }

  rt:after {
    content: '';
    display: inline-block;
    width: 1.2em;
  }
}

h-ru h-ru[zhuyin] {
  margin-top: -0.4em;
  margin-bottom: -0.2em;
  line-height: 1.8;
}
